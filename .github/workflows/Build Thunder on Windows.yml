name: Build Thunder on Windows

on:
  pull_request:
    branches: ["master"]

env:
  branch: ${{ github.head_ref || github.ref_name }} 
  bridge: Thunder\Source\WPEFramework\bridge.vcxproj
  comProcess: Thunder\Source\WPEProcess\comprocess.vcxproj
  devEnv: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\devenv.com
  solution: Thunder.sln

jobs:
  Thunder:
    runs-on: windows-latest

    strategy:
      matrix:
        type: [Debug, Release]
        version: [64, 86]

    name: Build type - ${{matrix.type}}${{matrix.version}}
    steps:
    
# ----- ThunderOnWindows -----
    - name: Checkout ThunderOnWindows
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows
        repository: WebPlatformForEmbedded/ThunderOnWindows

# ----- Thunder -----
    - name: Checkout Thunder - default
      if: ${{ !contains(github.event.pull_request.body, '[DependsOnThunder]') }}
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/Thunder
        repository: ${{github.repository_owner}}/Thunder

    - name: Checkout Thunder - ${{env.branch}}
      if: contains(github.event.pull_request.body, '[DependsOnThunder]')
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/Thunder
        repository: ${{github.repository_owner}}/Thunder
        ref: ${{env.branch}}

# ----- ThunderTools -----
    - name: Checkout ThunderTools - default
      if: ${{ !contains(github.event.pull_request.body, '[DependsOnThunderTools]') }}
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/ThunderTools
        repository: ${{github.repository_owner}}/ThunderTools

    - name: Checkout ThunderTools - ${{env.branch}}
      if: contains(github.event.pull_request.body, '[DependsOnThunderTools]')
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/ThunderTools
        repository: ${{github.repository_owner}}/ThunderTools
        ref: ${{env.branch}}

# ----- ThunderClientLibraries -----
    - name: Checkout ThunderClientLibraries
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/ThunderClientLibraries
        repository: ${{github.repository_owner}}/ThunderClientLibraries

# ----- ThunderInterfaces -----
    - name: Checkout ThunderInterfaces
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/ThunderInterfaces
        repository: ${{github.repository_owner}}/ThunderInterfaces

# ----- ThunderNanoServices -----
    - name: Checkout ThunderNanoServices
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/ThunderNanoServices
        repository: ${{github.repository_owner}}/ThunderNanoServices

# ----- ThunderNanoServicesRDK -----
    - name: Checkout ThunderNanoServicesRDK
      uses: actions/checkout@v3
      with:
        path: ThunderOnWindows/ThunderNanoServicesRDK
        repository: WebPlatformForEmbedded/ThunderNanoServicesRDK

# ----- Building -----
    - name: Install jsonref
      run: pip install jsonref

    - name: Build Thunder
      shell: cmd
      run: |
        cd ThunderOnWindows
        "%devEnv%" /Build "${{matrix.type}}|x${{matrix.version}}" /Project "%bridge%"  "%solution%"
        "%devEnv%" /Build "${{matrix.type}}|x${{matrix.version}}" /Project "%comProcess%"  "%solution%"
        
    - name: Tar files
      run: tar -czvf ${{matrix.type}}${{matrix.version}}.tar.gz artifacts
    
    - name: Upload
      uses: actions/upload-artifact@v3
      with:
        name: Thunder-${{matrix.type}}${{matrix.version}}-artifact
        path: ${{matrix.type}}${{matrix.version}}.tar.gz
